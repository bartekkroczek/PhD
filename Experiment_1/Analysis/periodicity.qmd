---
title: "Periodicity"
author: "Bartek Kroczek"
format: html
editor: source
---
```{r}
library(tidyverse)
library(ggplot2)
library(papaja)
library(reticulate)
library(WaveletComp)
```


```{r}
#| label: load-data
#| include: false

data.names <-
  list.files('../Data', full.names = T, pattern = '*.csv$')
data.files <- read_csv(data.names)
```

```{r}
#| include: false
data.aggr <-
  data.files |>
  filter(Trial_type == "experiment", Rt > 0.0) |> # Experiment and no timeout
  select(PART_ID, CSI, Corr) |>
  mutate(t = CSI * 16.6) |>
  group_by(PART_ID, t) |>
  summarise(mean_corr = 100.0 * mean(Corr)) 
```

```{r}
#| echo: false
data.aggr |> 
  filter(PART_ID == "140M21") |>
  ggplot(mapping = aes(x=t, y=mean_corr/100.0)) +
  geom_point() +
  geom_line() + 
  geom_smooth(method='lm', formula = y ~ x) +
  ggtitle("Single participant data", 
          subtitle = "Blue line represents linear regression fitted to data") + 
  scale_y_continuous(labels = scales::percent) +
  labs(x = "PDI in [ms]", y = "Average correctness") +
  theme_apa()
```

```{r}
unique_participants <- unique(data.aggr$PART_ID)

# Initialize an empty tibble to store results
ljung_box_results <-
  tibble(
    PART_ID = character(),
    p_value = numeric(),
    statistic = numeric(),
    lag = integer(),
    method = character()
  )

for (part_id in unique_participants) {
  part_data <- filter(data.aggr, PART_ID == part_id) %>% arrange(t)
  
  
  test_result <- Box.test(part_data$mean_corr, type = "Ljung-Box")
  
  # Append the results to the ljung_box_results tibble
  ljung_box_results <- ljung_box_results %>%
    add_row(
      PART_ID = part_id,
      p_value = test_result$p.value,
      statistic = test_result$statistic,
      lag = test_result$parameter,
      method = test_result$method
    )
  
}

ljung_box_results <- ljung_box_results %>%
  arrange(p_value) %>%
  mutate(rank = row_number(),
         adjusted_p_value = p.adjust(p_value, method = "BH"))


# View the results
print(ljung_box_results)
```
Benjamini-Hochberg (BH) is more suitable for exploratory research where you are dealing with a large number of independent tests

```{r}
# How many participants has significant values 
ljung_box_results |> summarise(
  Significant_Raw = sum(p_value < 0.05),
  Significant_Adjusted = sum(adjusted_p_value < 0.05))
```


```{r}

my.data <- data.aggr |> filter(PART_ID == "8M24") |> arrange(t)

my.data <- data.frame(x = my.data$mean_corr)

my.w <- analyze.wavelet(my.data, "x",
loess.span = 0,
dt = 1, dj = 1/60,
lowerPeriod = 2,
upperPeriod = 32,
make.pval = TRUE, n.sim = 50)

```

```{r}
# Z JAKIEGOÅš DZIWNEGO POWODU P VALUE JEEST USTALONE NA P=0.1
wt.image(my.w, color.key = "quantile", n.levels = 250,
legend.params = list(lab = "wavelet power levels", mar = 4.7))
```

```{r}
reconstruct(my.w, plot.waves = FALSE, lwd = c(1,2),
legend.coords = "bottomleft")
```

```{r}
my.w$Power.pval != 0 & my.w$Power.pval <0.05
```

```{r}
my.w$Power.pval
```


